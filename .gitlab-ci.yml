# GitLab CI/CD設定 - VSCode拡張機能のビルドとパッケージング

stages:
  - build
  - package
  - release

variables:
  NODE_VERSION: "20"

# キャッシュ設定
.node_cache: &node_cache
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/

# ビルドジョブ
build:
  stage: build
  image: node:${NODE_VERSION}
  <<: *node_cache
  script:
    - npm ci
    - npm run compile
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_PIPELINE_SOURCE == "web"

# VSIXパッケージ作成ジョブ（mainブランチまたは手動実行）
package:
  stage: package
  image: node:${NODE_VERSION}
  <<: *node_cache
  needs:
    - build
  before_script:
    - npm ci
    - npm install -g @vscode/vsce
  script:
    - vsce package --no-dependencies
    - mkdir -p packages
    - mv *.vsix packages/
  artifacts:
    paths:
      - packages/*.vsix
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_PIPELINE_SOURCE == "web"

# リリースジョブ（タグ付きコミットのみ）
release:
  stage: release
  image: node:${NODE_VERSION}
  <<: *node_cache
  needs:
    - build
  before_script:
    - npm ci
    - npm install -g @vscode/vsce
  script:
    - VERSION=$(node -p "require('./package.json').version")
    - vsce package --no-dependencies -o "ccexp-vscode-${VERSION}.vsix"
    - mkdir -p packages
    - mv *.vsix packages/
  artifacts:
    paths:
      - packages/*.vsix
    expire_in: 30 days
    name: "ccexp-vscode-${CI_COMMIT_TAG}"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  release:
    tag_name: $CI_COMMIT_TAG
    description: "Release $CI_COMMIT_TAG"
    assets:
      links:
        - name: "VSCode Extension Package"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/download"
